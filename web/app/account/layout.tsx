import type { Metadata } from "next";
import SetToken, { getClientIP } from "@/app/Auth/IsAuth/SetToken";
import Script from "next/script";
import { headers } from "next/headers";
import { AnimatedBackground } from "../dashboard/@auth/Components/animated-background";
import IsAuth from "../Auth/IsAuth/IsAuth";
import { redirect } from "next/navigation";

export const metadata: Metadata = {
  title: {
    default: `Authentication`,
    template: `%s - Authentications`
  },
  description: "Generated by create next app",
};

export default async function Layout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  let h = await headers()
  let au = h.get(`user-agent`)?.split(/\s+/).join('')
  let token = await SetToken()
  // 
  let ky = [`${au}`, `${await getClientIP(h)}`]
  let session = await SetToken({
    expiresIn: '10m',
    algorithm: 'HS512'
  }, ky)
  // 
  let auth = await IsAuth()
  if(auth) {
    return redirect(`/dashboard`)
  }
  return (
    <>
    <Script defer>
      {`if (typeof window !== 'undefined') {
        window.document.cookie = '_athk_=${token}';
      }`}
    </Script>
    {/*  */}
    <AnimatedBackground/>
     {children}
    </>
  );
}
